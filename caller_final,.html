<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bingo House â€” Caller & Cartelas</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        background: #0f1724;
        color: #e6eef8;
        font-family: sans-serif;
        margin: 0;
        padding: 16px;
      }
      h1 {
        margin: 0 0 12px;
        text-align: center;
        font-size: 28px;
        color: #fbbf24;
      }

      button {
        background: #f59e0b;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        margin: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      button.secondary {
        background: #1f2937;
        color: #94a3b8;
      }
      button.ghost {
        background: transparent;
        color: #94a3b8;
        border: 1px solid #2b3443;
      }
      button:hover {
        opacity: 0.95;
      }

      .wrap {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 16px;
      }
      .panel {
        background: #0b1220;
        padding: 12px;
        border-radius: 12px;
      }

      /* Ball */
      .ball {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #fff;
        color: #062024;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: bold;
        margin: 0 auto;
      }
      .ball small {
        font-size: 14px;
        color: #222;
      }

      /* 1â€“75 numbers grid */
      .grid75 .row {
        display: flex;
        gap: 4px;
        margin: 2px 0;
        align-items: center;
      }
      .rowHead {
        width: 20px;
        font-weight: bold;
        color: #fbbf24;
        font-size: 16px;
      }
      .num {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: #1e293b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: #94a3b8;
        transition: 0.2s;
      }
      .num.called {
        background: #f59e0b;
        color: #062024;
        box-shadow: 0 0 6px #fbbf24;
      }

      /* Cartela IDs */
      .cartelaBtn {
        background: #1e293b;
        color: #f59e0b;
        padding: 6px 12px;
        margin: 4px;
        border-radius: 8px;
        cursor: pointer;
        display: inline-block;
        font-weight: bold;
        border: 1px solid #f59e0b;
      }
      .cartelaBtn:hover {
        background: #f59e0b;
        color: #062024;
      }

      /* Cartelas */
      .cards {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .card {
        background: #08162a;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 10px;
        width: 190px;
        display: none;
      }
      .card .title {
        font-weight: bold;
        margin-bottom: 6px;
        color: #fbbf24;
      }
      .cardGridHeader {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
        margin-bottom: 4px;
      }
      .headerCell {
        text-align: center;
        font-weight: bold;
        color: #f59e0b;
      }
      .cardGrid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
      }
      .cell {
        background: #071526;
        padding: 6px;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
      }
      .cell.free {
        color: #94a3b8;
      }
      .cell.marked {
        background: #10b981;
        color: #04221a;
      }

      /* Winner line */
      .winningLine {
        background: #fbbf24 !important;
        color: #111 !important;
        animation: glow 1s infinite alternate;
      }
      @keyframes glow {
        from {
          box-shadow: 0 0 6px #fbbf24;
        }
        to {
          box-shadow: 0 0 18px #facc15;
        }
      }

      /* Winner Money */
      #winnerMoneyBox {
        margin-top: 15px;
        background: #10b981;
        color: #062024;
        padding: 12px;
        border-radius: 10px;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 12px #10b981;
      }
      #winnerMoneyBox span {
        font-size: 22px;
      }

      #audioHint {
        text-align: center;
        color: #94a3b8;
        font-size: 13px;
        margin-top: 8px;
      }

      .langSelectBox {
        text-align: left;
        margin-top: 10px;
      }

      @media (max-width: 900px) {
        .wrap {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>Bingo House â€” Caller & Cartelas</h1>
    <div class="wrap">
      <!-- Caller -->
      <section class="panel">
        <div class="ball">
          <small id="currentLetter">â€“</small><span id="currentNum">â€“</span>
        </div>

        <div id="statusBar" style="text-align: center; margin: 10px 0">
          0 numbers drawn â€” Interval: <span id="intervalLabel">2000</span>ms
        </div>
        <div class="grid75" id="grid75"></div>

        <!-- Buttons -->
        <div style="margin-top: 20px; text-align: center">
          <button id="drawBtn">Draw</button>
          <button id="autoBtn" class="secondary">Auto: Off</button>
          <button id="pauseBtn" class="secondary">Pause</button>
          <button id="resetBtn" class="secondary">Reset</button><br />
          <button id="speedDown" class="ghost">- Speed</button>
          <button id="speedUp" class="ghost">+ Speed</button>
        </div>

        <div class="langSelectBox">
          <label for="langSelect">ðŸ”Š Sound language:</label><br />
          <select id="langSelect">
            <option value="sound">Amharic (Default)</option>
            <option value="afaan_oromo_sound">Afaan Oromo</option>
          </select>
        </div>

        <div id="audioHint">Click anywhere once to enable sound ðŸ”ˆ</div>
      </section>

      <!-- Cartelas -->
      <section class="panel">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <button id="addCardBtn" class="secondary">+ Add Cartela</button>
            <button id="checkWinnersBtn" class="secondary">
              Check Winners
            </button>
          </div>
          <input
            type="number"
            id="searchInput"
            placeholder="Search IDâ€¦"
            style="
              width: 120px;
              padding: 6px;
              border-radius: 6px;
              border: 1px solid #444;
            "
          />
        </div>
        <div style="margin: 10px 0">
          <label for="winMode">Winning Mode: </label>
          <select id="winMode">
            <option value="1">1 Line</option>
            <option value="2">2 Lines</option>
            <option value="3">3 Lines</option>
            <option value="full">Full House</option>
          </select>
        </div>
        <div id="cartelaList" style="margin-bottom: 8px">Loading cartelasâ€¦</div>
        <div class="cards" id="cardsArea"></div>
        <div
          id="winnerMessage"
          style="margin: 10px 0; font-size: 18px; font-weight: bold"
        ></div>
        <div id="winnerMoneyBox" style="display: none">
          á‹°áˆ«áˆ½: <span id="winnerMoney">0</span> birr
        </div>
        <div
          id="gameEndArea"
          style="display: none; margin: 10px 0; text-align: center"
        >
          <button
            id="endGameBtn"
            style="
              background: #ef4444;
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
            "
          >
            Game End
          </button>
        </div>
      </section>
    </div>

    <script>
      // ---------- CONFIG ----------
      const API_BASE = "http://localhost:4000"; // change if needed
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("userRole");

      // require login token (only token & role are stored)
      if (!token || (role !== "agent" && role !== "owner")) {
        alert("Please login first (agent or owner).");
        location.href = "login.html";
        throw new Error("Not authenticated");
      }

      // get gameId from URL
      const params = new URLSearchParams(window.location.search);
      const GAME_ID = params.get("gameId");
      if (!GAME_ID) {
        alert("Missing gameId - go to Number Selector.");
        location.href = "number_selector_updated.html";
        throw new Error("Missing gameId");
      }

      // UI refs
      const grid75 = document.getElementById("grid75");
      const currentLetter = document.getElementById("currentLetter");
      const currentNum = document.getElementById("currentNum");
      const statusBar = document.getElementById("statusBar");
      const cartelaList = document.getElementById("cartelaList");
      const cardsArea = document.getElementById("cardsArea");
      const winMode = document.getElementById("winMode");
      const checkWinnersBtn = document.getElementById("checkWinnersBtn");
      const searchInput = document.getElementById("searchInput");
      const intervalLabel = document.getElementById("intervalLabel");
      const audioHint = document.getElementById("audioHint");
      const langSelect = document.getElementById("langSelect");

      // numbers state
      const allNumbers = Array.from({ length: 75 }, (_, i) => i + 1);
      let remaining = [...allNumbers];
      let called = [];
      let autoTimer = null;
      let speed = 2000; // ms
      intervalLabel.textContent = speed;

      // audio
      let audioUnlocked = false;
      function trySpeakIntro() {
        try {
          const utter = new SpeechSynthesisUtterance("The Game is started");
          utter.lang = "en-US";
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utter);
          audioUnlocked = true;
          audioHint.textContent = "âœ… Audio ready â€” press Draw to hear sound!";
        } catch (e) {
          // ignored
        }
        const audio = new Audio("sound/intro_en.m4a");
        audio
          .play()
          .then(() => {
            audioUnlocked = true;
            audioHint.textContent =
              "âœ… Audio ready â€” press Draw to hear sound!";
          })
          .catch(() => {});
      }
      trySpeakIntro();
      document.body.addEventListener(
        "click",
        () => {
          if (!audioUnlocked) {
            const unlock = new Audio();
            unlock.play().catch(() => {});
            audioUnlocked = true;
            audioHint.textContent =
              "âœ… Audio enabled â€” press Draw to hear sound!";
            trySpeakIntro();
          }
        },
        { once: true }
      );

      let currentFolder = langSelect.value || "sound";
      langSelect.addEventListener(
        "change",
        (e) => (currentFolder = e.target.value)
      );

      function speakNumber(letter, number) {
        if (!audioUnlocked) return;
        const file = `${currentFolder}/${letter}${number}.m4a`;
        const a = new Audio(file);
        a.play().catch(() => {
          try {
            const u = new SpeechSynthesisUtterance(`${letter} ${number}`);
            u.lang = "en-US";
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
          } catch (e) {}
        });
      }

      // build grid UI
      function buildGrid75() {
        grid75.innerHTML = "";
        ["B", "I", "N", "G", "O"].forEach((L, ci) => {
          const row = document.createElement("div");
          row.className = "row";
          const head = document.createElement("div");
          head.className = "rowHead";
          head.textContent = L;
          row.appendChild(head);
          for (let i = 1; i <= 15; i++) {
            const num = ci * 15 + i;
            const el = document.createElement("div");
            el.className = "num";
            el.dataset.n = num;
            el.textContent = num;
            row.appendChild(el);
          }
          grid75.appendChild(row);
        });
      }
      buildGrid75();

      function letterFor(n) {
        if (n <= 15) return "B";
        if (n <= 30) return "I";
        if (n <= 45) return "N";
        if (n <= 60) return "G";
        return "O";
      }

      function markNumberUI(n) {
        const el = grid75.querySelector(`.num[data-n='${n}']`);
        if (el) el.classList.add("called");
      }

      function syncRemainingFromCalled() {
        const set = new Set(called.map(Number));
        remaining = allNumbers.filter((n) => !set.has(n));
      }

      // ---------- Draw logic ----------
      async function drawNumber() {
        if (!remaining.length) {
          alert("All numbers have been drawn.");
          return;
        }
        const idx = Math.floor(Math.random() * remaining.length);
        const num = remaining.splice(idx, 1)[0];
        const L = letterFor(num);
        currentLetter.textContent = L;
        currentNum.textContent = num;
        called.push(num);
        markNumberUI(num);
        updateCards(num);
        statusBar.textContent = `${called.length} numbers drawn â€” Interval: ${speed}ms`;
        speakNumber(L, num);

        // Save to backend (full called array for idempotency)
        try {
          await fetch(`${API_BASE}/api/games/${GAME_ID}/called`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ numbers: called }),
          });
        } catch (err) {
          console.warn("Failed to save called numbers:", err);
        }
      }

      // Auto
      function startAuto() {
        if (autoTimer) return;
        speed = Math.max(200, Number(speed));
        intervalLabel.textContent = speed;
        autoTimer = setInterval(() => {
          if (!remaining.length) {
            stopAuto();
            return;
          }
          drawNumber();
        }, speed);
        document.getElementById("autoBtn").textContent = "Auto: On";
      }
      function stopAuto() {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = null;
        document.getElementById("autoBtn").textContent = "Auto: Off";
      }
      function toggleAuto() {
        if (autoTimer) stopAuto();
        else startAuto();
      }

      // Pause (pause/resume auto)
      document.getElementById("pauseBtn").addEventListener("click", () => {
        const btn = document.getElementById("pauseBtn");
        if (autoTimer) {
          stopAuto();
          btn.textContent = "Resume";
        } else {
          startAuto();
          btn.textContent = "Pause";
        }
      });

      // Reset
      async function resetCaller() {
        if (
          !confirm(
            "Reset all drawn numbers (this will clear called numbers both locally and on server)?"
          )
        )
          return;
        stopAuto();
        remaining = [...allNumbers];
        called = [];
        currentLetter.textContent = "â€“";
        currentNum.textContent = "â€“";
        statusBar.textContent = "0 numbers drawn â€” Interval: " + speed + "ms";
        grid75
          .querySelectorAll(".num")
          .forEach((el) => el.classList.remove("called"));
        document
          .querySelectorAll(".cell.marked")
          .forEach((c) => c.classList.remove("marked"));
        document
          .querySelectorAll(".card")
          .forEach((c) => (c.style.boxShadow = "none"));
        // clear on server
        try {
          await fetch(`${API_BASE}/api/games/${GAME_ID}/called`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ numbers: [] }),
          });
        } catch (err) {
          console.warn("Failed to clear server called numbers", err);
        }
      }

      // Speed up/down
      document.getElementById("speedUp").addEventListener("click", () => {
        speed = Math.max(200, speed - 500);
        intervalLabel.textContent = speed;
        if (autoTimer) {
          stopAuto();
          startAuto();
        }
      });
      document.getElementById("speedDown").addEventListener("click", () => {
        speed = speed + 500;
        intervalLabel.textContent = speed;
        if (autoTimer) {
          stopAuto();
          startAuto();
        }
      });

      // End game
      async function endGame() {
        if (!confirm("End and save this game?")) return;
        stopAuto();
        try {
          await fetch(`${API_BASE}/api/games/${GAME_ID}/finish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({ status: "completed", numbers: called }),
          });
          alert("Game ended and saved.");
          location.href = "number_selector_updated.html";
        } catch (err) {
          console.error("Failed to finish game", err);
          alert("Failed to end game - check server.");
        }
      }
      document.getElementById("endGameBtn").addEventListener("click", endGame);

      // ---------- Cartelas ----------
      let cartelasData = [];

      // deterministic generator for grid if backend doesn't provide one
      function makeGridFromId(id) {
        const seed = String(id)
          .split("")
          .reduce((s, ch) => s + ch.charCodeAt(0), 0);
        let s = seed;
        function rnd(min, max) {
          s = (s * 48271) % 2147483647;
          const r = s % (max - min + 1);
          return min + r;
        }
        const cols = [];
        for (let c = 0; c < 5; c++) {
          const base = 1 + c * 15;
          const pool = Array.from({ length: 15 }, (_, i) => base + i);
          // shuffle pool lightly via seed
          for (let k = pool.length - 1; k > 0; k--) {
            const j = rnd(0, k);
            [pool[k], pool[j]] = [pool[j], pool[k]];
          }
          cols.push(pool.slice(0, 5));
        }
        return cols;
      }

      function renderCartelas(list) {
        cartelasData = list.map((c) => {
          if (typeof c === "object")
            return { id: c.id || c.Id || c.name, grid: c.grid || null };
          return { id: String(c), grid: null };
        });

        if (!cartelasData.length) {
          cartelaList.textContent = "No cartelas registered for this game yet.";
          cardsArea.innerHTML = "";
          return;
        }

        cartelaList.innerHTML = `Registered cartelas: ${cartelasData.length} â€” Click a cartela to view`;
        cardsArea.innerHTML = "";

        cartelasData.forEach((c) => {
          const cardBtn = document.createElement("button");
          cardBtn.className = "cartelaBtn";
          cardBtn.textContent = c.id;
          cardBtn.addEventListener("click", () => {
            let existing = cardsArea.querySelector(`.card[data-id='${c.id}']`);
            if (existing) {
              existing.style.display =
                existing.style.display === "none" ? "block" : "none";
              return;
            }
            const cols = c.grid || makeGridFromId(c.id);
            const card = document.createElement("div");
            card.className = "card";
            card.dataset.id = c.id;
            card.innerHTML = `<div class="title">Cartela ${c.id}</div>
              <div class="cardGridHeader">
                <div class="headerCell">B</div><div class="headerCell">I</div><div class="headerCell">N</div><div class="headerCell">G</div><div class="headerCell">O</div>
              </div>
              <div class="cardGrid"></div>`;
            const grid = card.querySelector(".cardGrid");
            for (let r = 0; r < 5; r++) {
              for (let ci = 0; ci < 5; ci++) {
                const val = ci === 2 && r === 2 ? "FREE" : cols[ci][r];
                const cell = document.createElement("div");
                cell.className = "cell";
                if (val === "FREE") {
                  cell.classList.add("free");
                  cell.textContent = "â˜…";
                  cell.dataset.free = "1";
                } else {
                  cell.textContent = val;
                  cell.dataset.n = val;
                  if (called.includes(Number(val)))
                    cell.classList.add("marked");
                }
                grid.appendChild(cell);
              }
            }
            cardsArea.appendChild(card);
          });
          cartelaList.appendChild(cardBtn);
        });
      }

      function updateCards(num) {
        document
          .querySelectorAll(`.cell[data-n='${num}']`)
          .forEach((c) => c.classList.add("marked"));
      }

      // basic winner checking
      function checkWinners() {
        const mode = winMode.value;
        let winnerFound = false;
        document.querySelectorAll(".card").forEach((card) => {
          card
            .querySelectorAll(".cell")
            .forEach((c) => c.classList.remove("winningLine"));
          const cells = [...card.querySelectorAll(".cell")];
          const grid = [];
          for (let i = 0; i < 25; i += 5) grid.push(cells.slice(i, i + 5));
          let lines = 0;
          function markLine(line) {
            line.forEach((c) => c.classList.add("winningLine"));
          }
          // rows
          grid.forEach((row) => {
            if (
              row.every((c) => c.classList.contains("marked") || c.dataset.free)
            ) {
              lines++;
              markLine(row);
            }
          });
          // cols
          for (let ci = 0; ci < 5; ci++) {
            const col = grid.map((r) => r[ci]);
            if (
              col.every((c) => c.classList.contains("marked") || c.dataset.free)
            ) {
              lines++;
              markLine(col);
            }
          }
          // diagonals
          const diag1 = [0, 1, 2, 3, 4].map((i) => grid[i][i]);
          if (
            diag1.every((c) => c.classList.contains("marked") || c.dataset.free)
          ) {
            lines++;
            markLine(diag1);
          }
          const diag2 = [0, 1, 2, 3, 4].map((i) => grid[i][4 - i]);
          if (
            diag2.every((c) => c.classList.contains("marked") || c.dataset.free)
          ) {
            lines++;
            markLine(diag2);
          }

          const full = cells.every(
            (c) => c.classList.contains("marked") || c.dataset.free
          );
          let win = false;
          if (mode === "full" && full) win = true;
          else if (mode !== "full" && Number(mode) <= lines) win = true;

          if (win) {
            winnerFound = true;
            card.style.display = "block";
            document.getElementById("winnerMessage").style.color =
              mode === "full" ? "#10b981" : "#f59e0b";
            document.getElementById("winnerMessage").textContent = `Cartela ${
              card.dataset.id
            } WON (${mode === "full" ? "FULL HOUSE" : lines + " line(s)"})!`;
            document.getElementById("gameEndArea").style.display = "block";
            card.style.boxShadow = "0 0 8px rgba(245,158,11,0.6)";
          } else {
            card.style.boxShadow = "none";
          }
        });

        if (!winnerFound) {
          document.getElementById("winnerMessage").textContent =
            "No winners yet.";
        }
      }

      // check by ID (search)
      searchInput.addEventListener("change", () => {
        const v = (searchInput.value || "").toString().trim();
        if (!v) {
          // show none
          document
            .querySelectorAll(".card")
            .forEach((c) => (c.style.display = "none"));
          return;
        }
        let found = false;
        document.querySelectorAll(".card").forEach((c) => {
          if (c.dataset.id === v) {
            c.style.display = "block";
            found = true;
          } else {
            c.style.display = "none";
          }
        });
        if (!found) alert("Not registered!");
      });

      // add card (local quick-add)
      let localCardCounter = 0;
      document.getElementById("addCardBtn").addEventListener("click", () => {
        localCardCounter++;
        const id = `LOCAL-${localCardCounter}`;
        renderCartelas([...(cartelasData || []), id]);
      });

      document
        .getElementById("checkWinnersBtn")
        .addEventListener("click", checkWinners);

      // ---------- Load game & cartelas from server ----------
      async function loadGame() {
        try {
          // game info
          const res = await fetch(`${API_BASE}/api/games/${GAME_ID}`, {
            headers: { Authorization: "Bearer " + token },
          });
          const j = await res.json();
          const g = j.game || j;
          // if game includes called numbers, restore
          if (Array.isArray(g.called) && g.called.length) {
            called = Array.from(g.called.map(Number));
            syncRemainingFromCalled();
            called.forEach((n) => markNumberUI(n));
            if (called.length) {
              const last = called[called.length - 1];
              currentLetter.textContent = letterFor(last);
              currentNum.textContent = last;
              statusBar.textContent = `${called.length} numbers drawn â€” Interval: ${speed}ms`;
            }
          }

          // cartelas
          const rc = await fetch(`${API_BASE}/api/games/${GAME_ID}/cartelas`, {
            headers: { Authorization: "Bearer " + token },
          });
          const jc = await rc.json();
          const list = jc.cartelas || jc || [];
          renderCartelas(list);
        } catch (err) {
          console.error("Failed to load game or cartelas", err);
          cartelaList.textContent = "Failed to load cartelas from server.";
        }
      }

      // start bindings for draw / auto / reset
      document.getElementById("drawBtn").addEventListener("click", drawNumber);
      document.getElementById("autoBtn").addEventListener("click", toggleAuto);
      document
        .getElementById("resetBtn")
        .addEventListener("click", resetCaller);

      // start
      loadGame();
    </script>
  </body>
</html>

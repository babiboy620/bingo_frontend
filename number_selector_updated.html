<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Number Selector — Bingo House</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        text-align: center;
        background: #0f1724;
        color: #e6eef8;
      }
      h1 {
        color: #fbbf24;
      }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        max-width: 1000px;
        margin: auto;
      }
      #countBox {
        background: #2196f3;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
      }
      .dropdowns {
        display: flex;
        gap: 10px;
      }
      select {
        padding: 8px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #aaa;
      }
      .numbers {
        display: grid;
        grid-template-columns: repeat(22, 1fr);
        gap: 6px;
        max-width: 1000px;
        margin: 0 auto 20px auto;
      }
      .number {
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #999;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        background: #1e293b;
        color: #94a3b8;
        transition: 0.2s;
      }
      .number.selected {
        background: #4caf50;
        color: white;
        border-color: #388e3c;
        font-weight: bold;
      }
      .bottom-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      .bottom-buttons button {
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: #666;
        color: white;
        transition: 0.2s;
      }
      .bottom-buttons button:hover {
        background: #fa0c0c;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .bottom {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 20px;
        max-width: 1000px;
        margin: auto;
      }
      .resultBox {
        background: #ff9800;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        min-width: 180px;
        text-align: center;
      }
      #actionBtn {
        padding: 12px 30px;
        font-size: 18px;
        font-weight: bold;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
      }
      #actionBtn:hover {
        background: #1136dd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <button
    onclick="localStorage.clear(); sessionStorage.clear(); location.href='index.html';"
    style="
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      float: right;
    "
  >
    Logout
  </button>
  <body>
    <h1>Cartela ID Selection</h1>
    <div class="top">
      <div id="countBox">Selected: 0</div>
      <div class="dropdowns">
        <select id="multiplier">
          <option value="">--Choose--</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
          <option value="60">60</option>
          <option value="70">70</option>
          <option value="80">80</option>
          <option value="90">90</option>
          <option value="100">100</option>
        </select>
        <select id="winMode">
          <option value="1">Win: 1 Line</option>
          <option value="2">Win: 2 Lines</option>
          <option value="3">Win: 3 Lines</option>
          <option value="full">Win: Full House</option>
        </select>
      </div>
    </div>

    <div class="numbers" id="numberContainer"></div>

    <div class="bottom-buttons">
      <button id="moreBtn">+ More</button>
      <button id="unmarkBtn">Unmark All</button>
    </div>

    <div class="bottom">
      <div id="totalBox" class="resultBox">Total Pot: 0</div>
      <div id="profitBox" class="resultBox">My Profit: 0</div>
      <div id="winnerBox" class="resultBox">Winner's Money: 0</div>
    </div>

    <div style="text-align: center; margin-top: 30px">
      <button id="actionBtn" onclick="goToCaller()">Go to Caller</button>
    </div>

    <script>
      const API_BASE = "http://localhost:4000";

      function getStorageValue(key) {
        return localStorage.getItem(key) || sessionStorage.getItem(key);
      }

      const token = getStorageValue("token");
      const role = getStorageValue("userRole");

      if (!token || role !== "agent") {
        setTimeout(() => {
          const tokenCheck = getStorageValue("token");
          const roleCheck = getStorageValue("userRole");
          if (!tokenCheck || roleCheck !== "agent") {
            alert("Access denied — agents only!");
            window.location.href = "agent_login.html";
          }
        }, 300);
      }

      const numberContainer = document.getElementById("numberContainer");
      const multiplierBox = document.getElementById("multiplier");
      const countBox = document.getElementById("countBox");
      const moreBtn = document.getElementById("moreBtn");
      const unmarkBtn = document.getElementById("unmarkBtn");
      const totalBox = document.getElementById("totalBox");
      const profitBox = document.getElementById("profitBox");
      const winnerBox = document.getElementById("winnerBox");
      const winMode = document.getElementById("winMode");

      let selectedNumbers = new Set();
      let moreVisible = false;

      // Create 1–200 cartela IDs
      for (let i = 1; i <= 200; i++) {
        const div = document.createElement("div");
        div.className = "number";
        div.textContent = i;
        div.dataset.num = i;
        div.addEventListener("click", () => {
          if (selectedNumbers.has(i)) {
            selectedNumbers.delete(i);
            div.classList.remove("selected");
          } else {
            selectedNumbers.add(i);
            div.classList.add("selected");
          }
          calculate();
        });
        if (i > 99) div.style.display = "none";
        numberContainer.appendChild(div);
      }

      moreBtn.onclick = () => {
        moreVisible = !moreVisible;
        for (let i = 100; i <= 200; i++) {
          const div = numberContainer.querySelector(`.number[data-num='${i}']`);
          div.style.display = moreVisible ? "flex" : "none";
        }
        moreBtn.textContent = moreVisible ? "− Hide" : "+ More";
      };

      unmarkBtn.onclick = () => {
        selectedNumbers.clear();
        document
          .querySelectorAll(".number")
          .forEach((d) => d.classList.remove("selected"));
        calculate();
      };

      multiplierBox.onchange = calculate;

      function calculate() {
        const count = selectedNumbers.size;
        const bet = parseInt(multiplierBox.value);
        countBox.textContent = `Selected: ${count}`;
        if (!isNaN(bet) && count > 0) {
          const totalPot = count * bet;
          const profit = totalPot * 0.2;
          const winnerMoney = totalPot - profit;
          totalBox.textContent = `Total Pot: ${totalPot} birr`;
          profitBox.textContent = `My Profit (20%): ${profit} birr`;
          winnerBox.textContent = `Winner's Money: ${winnerMoney} birr`;
        } else {
          totalBox.textContent = "Total Pot: 0";
          profitBox.textContent = "My Profit: 0";
          winnerBox.textContent = "Winner's Money: 0";
        }
      }

      async function goToCaller() {
        const selected = [...selectedNumbers];
        if (selected.length === 0) return alert("Select at least one cartela");
        const bet = parseInt(multiplierBox.value);
        if (isNaN(bet)) return alert("Select a bet multiplier");

        const totalPot = selected.length * bet;
        const winnerMoney = totalPot * 0.8;
        const profit = totalPot * 0.2;

        const payload = {
          date: new Date().toLocaleDateString(),
          day: new Date().toLocaleDateString("en-US", { weekday: "long" }),
          players: selected.length,
          pot: totalPot,
          winnerMoney,
          profit,
          cartelas: selected,
          winMode: winMode.value,
        };

        try {
          const res = await fetch(API_BASE + "/api/games", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.success) return alert(data.error || "Failed to save game");
          const gameId = data.gameId || data.id || data.insertId;
          window.location.href =
            "caller_final.html?gameId=" + encodeURIComponent(gameId);
        } catch (err) {
          console.error(err);
          alert("Network error while saving game");
        }
      }
    </script>
  </body>
</html>
